# Compiler
CC = gcc
CFLAGS += -g -I/usr/include/tirpc -Wall -Wextra -pedantic -std=c11 -I$(CJSON_DIR) -w
LDLIBS += -lnsl -lpthread -lrt -ldl -ltirpc -L. -lclaves -Wl,-rpath=$(CJSON_DIR) -Wl,-rpath=$(CJSON_DIR)/$(CJSON_DIR) -lcjson -L$(CJSON_DIR)

# cJSON files
CJSON_DIR = cJSON
CJSON_LIB = $(CJSON_DIR)/libcjson.so
CJSON_URL = https://github.com/DaveGamble/cJSON.git

# Files
SOURCES.x = claves_iu.x
CLIENT_SRC = cliente.c
LIB_SRC = claves.c
LIB_HEADER = claves.h

TARGETS = claves_head.h claves_xdr.c claves_clnt.c claves_svc.c claves.c servidor.c cliente.c

# Object files
OBJECTS_CLNT = claves_clnt.o claves.o claves_xdr.o
OBJECTS_SVC = claves_svc.o servidor.o claves_xdr.o

LIBRARY = libclaves.so

.PHONY: all clean cJSON

all : cJSON $(LIBRARY) claves servidor cliente

# Link the client (library client)
claves: $(OBJECTS_CLNT)
	$(CC) $(CFLAGS) -o $@ $^ $(LDLIBS)

# Link the server
servidor: $(OBJECTS_SVC)
	$(CC) $(CFLAGS) -o $@ $^ $(LDLIBS)

# Link the application client
cliente: $(CLIENT_SRC) $(LIBRARY)
	$(CC) $(CFLAGS) -o $@ $^ $(LDLIBS)

# Library compilation
$(LIBRARY): $(LIB_SRC:.c=.o)
	$(CC) -shared -o $@ $^

# cJSON target
cJSON: $(CJSON_LIB)

$(CJSON_LIB):
	git clone $(CJSON_URL) $(CJSON_DIR)
	cd $(CJSON_DIR) && make

# Compile object files from C sources
%.o: %.c $(LIB_HEADER)
	$(CC) $(CFLAGS) -fPIC -c -o $@ $<

clean:
	rm -f *.o $(TARGETS) claves servidor cliente $(LIBRARY)
